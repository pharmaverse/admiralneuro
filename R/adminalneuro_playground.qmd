---
title: "playground"
format: html
---


```{r}
library(gtsummary)
library(dplyr)


data("nv_neuro")

# Prepare the data
nv_summary <- nv_neuro %>%
  # Filter for numeric tests
  filter(NVTESTCD %in% c("AMYSUVRCB", "AMYSUVRCOM", "TAUSUVRICBGM")) %>%
  # Join with demographic data to get ARM
  left_join(dm_neuro %>% select(USUBJID, ARM), by = "USUBJID")

# Create gtsummary table
nv_summary_table <- nv_summary %>%
  # Group by ARM and VISIT
  group_by(ARM, VISITNUM) %>%
  # Create summary table
  tbl_summary(
    by = VISITNUM,
    include = c(NVSTRESN),
    label = list(
      NVSTRESN = "Standardized Numeric Result"
    ),
    statistic = list(
      NVSTRESN ~ c("{mean} ({sd})", 
                   "{median} ({p25}, {p75})", 
                   "{min}, {max}")
    )
  ) %>%
  # Add overall column
  add_overall() %>%
  # Modify header
  modify_header(
    label = "**Measurement**",
    stat_by = "**Visit {by}**"
  ) %>%
  # Bold variable labels
  bold_labels() %>%
  # Add a title
  modify_caption("**Neuroimaging Measurements by Treatment Arm and Visit**")

# Print the table
nv_summary_table


```


```{r}
ggplot(nv_summary, aes(x = factor(VISITNUM), y = NVSTRESN, fill = ARM)) +
  geom_boxplot() +
  facet_wrap(~ NVTESTCD, scales = "free_y") +
  labs(
    title = "Neuroimaging Measurements by Visit and Treatment Arm",
    x = "Visit Number",
    y = "Standardized Numeric Result"
  ) +
  theme_minimal()

# Statistical testing
library(rstatix)

# Perform statistical tests
stat_tests <- nv_summary %>%
  group_by(NVTESTCD) %>%
  wilcox_test(NVSTRESN ~ ARM, p.adjust.method = "bonferroni") %>%
  add_significance()

print(stat_tests)


```

